---
date: 2020.05.28
title: 서비스워커
tag: 서비스워커, service worker
---

# 서비스워커

### 기본개념

- 브라우저 백그라운드에서 웹페이지와는 별개로 작동하는 자바스크립트
- DOM에 직접 접근할 수 없는 대신 페이지와 통신은 가능(페이지에서 DOM 조작)
- 스크립트가 위치한 경로의 페이지를 제어 - 푸시 알림, 백그라운드 동기화, 캐시 등
- localhost 또는 HTTPS에서 동작

### 수명주기

- download : 사용자가 페이지에 접근시 첫 방문 또는 24시간마다 서비스워커 스크립트를 브라우저로 다운로드 진행
- install : 처음 다운로드했거나 다운로드한 파일이 기존 서비스워커와 1바이트라도 다르면 설치 진행
- activate : 설치가 끝나면 바로 활성화되는 것이 아님
  - 아직 제어되지 않은 클라이언트(첫 방문) : 페이지를 새로고침하면 활성화가 적용된 페이지를 볼 수 있다. clients.claim() 를 사용하면 새로고침하지 않아도 즉시 활성화를 적용한다. 단, 기존 서비스워커를 사용하는 탭이 없어야 함.
  - 기존 서비스워커 : 기존 서비스워커를 사용하는 탭이 하나라도 있으면 새로운 서비스워커가 동작하지 않는다. 새로고침만으로는 해결되지 않으며, 해당 탭을 모두 닫거나 다른 사이트로 이동한 후 다시 방문해야 함. skipWaiting()을 사용하면 기존 서비스워커를 중지시키고 새로운 서비스워커를 바로 활성화한다.
  - 서비스워커 업데이트는 크롬 업데이트와 유사한 방식 : 백그라운드에서 다운로드 -> 크롬이 다시 시작될 때까지 적용되지 않음 -> 그 동안 현재 버전을 중단 없이 계속 사용

### 일반적인 캐싱

- install 단계에서 정적 파일을 캐시에 저장
- activate 단계에서 오래된 캐시를 삭제
- fetch 단계에서 요청이 캐시에 존재하면 캐시로 응답

### 관련 라이브러리

WORKBOX, SW-PRECACHE 등의 라이브러리가 있다

```bash
npm install workbox-cli --global
workbox wizard
workbox generateSW ./workbox-config.js
```

### 예제 따라해보기

- 개, 고양이, 말, 소 예제
  - clients.claim()
    - 새 시크릿모드 (고양이) -> 개 -> 새로고침 -> 고양이
    - 새 시크릿모드 (clients.claim()) -> 고양이
  - skipWaiting()
    - 새 시크릿모드 (고양이) -> 개 -> 새로고침 -> 고양이 -> 새 탭 (말) -> 고양이 -> 탭1 닫기 -> 탭2 다른 사이트로 이동 후 복귀 -> 말
    - 새 시크릿모드 (고양이) -> 개 -> 새로고침 -> 고양이 -> 새 탭 (skipWaiting()) -> 소

### Sapper에서 사용

- 캐시이름에 @sapper/service-worker.js의 timestamp를 사용하면, 앱을 빌드할 때마다 캐시를 갱신
- rel="prefetch" 링크의 본문을 캐시하고자 service-worker.js 파일을 수정. 캐시 후 서버를 꺼도 동작함. 그러나 본문을 수정해도 캐시가 갱신되지 않는다. 서비스워커가 활성화된 후 캐시스토리지의 내용이 업데이트되지 않는 것 같다.

### 참고

- https://gracefullight.dev/2017/12/22/PWA-ServiceWorker-Web-Caching/
- https://developers.google.com/web/fundamentals/primers/service-workers/